# OCR結果の出力置換プラン（pdf_extractor/outputs への移植）

目的と背景
---------
- `paper/ocr_references/` のOCR本文を正本として、`paper/pdf_extractor/outputs/<Key>/result.md` を置き換える。
- 置換時に明らかなOCR崩れ（改行、連結ミス等）を整形し、読みやすい完成版にする。
- 数式はOCR精度が低いため、**数式番号のみのプレースホルダ**に置換して後日手入力で補完する。

対象範囲
--------
- 対象: `paper/ocr_references/*.md` と `paper/pdf_extractor/outputs/*/result.md`
- 対象: Key 名の整合（必要ならファイル名のリネーム）
- 対象: 本文整形・数式プレースホルダ化

非対象範囲
----------
- 数式の内容復元（後日手入力のため本プランでは実施しない）
- 画像抽出の再処理（`images/` は現状維持）
- 文献の正誤・内容の事実確認（OCR整形のみ）

成果物
------
- `paper/pdf_extractor/outputs/<Key>/result.md` の本文が高精度OCRへ段階的に置換済み
- `paper/ocr_references/` は置換完了・追加作業の凍結後に削除予定（削除は完了判定後に実行）

更新頻度
--------
- OCR追加が発生したタイミングで随時更新する（最長でも月1回は対応表と保留リストを更新）
- 大量追加がある場合は「追加作業の波」を1スプリントとして区切り、完了確認まで実施する

数式プレースホルダ方針
----------------------
- ブロック数式・インライン数式ともに `[[EQN:(番号)]]` へ置換
- 式番号が明示されていない場合は `[[EQN:unnumbered]]` を使用
- 本文中の参照（例: “Eq. (2)”）はそのまま保持
- 置換時にOCR式を残したい場合は、直後に `<!-- OCR_EQN_RAW: ... -->` を追加（任意）

本文整形ルール（最小限・保守的）
--------------------------------
- ヘッダ/フッタ、ページ番号、印刷情報など「本文ではないもの」の除去
- ハイフン改行の復元と段落の連結整理（意味変更を伴わない範囲）
- 文字化けやOCR誤認の修正は「原文で確認できる場合のみ」
- 数式はプレースホルダ化（上記方針）

精度保証ポリシー（必須）
----------------------
- 意味解釈を伴う修正は禁止（言い換え、要約、補完をしない）
- 数値/単位/化学式/固有名詞/記号の変更は原文照合必須（照合できない場合は変更しない）
- 迷う箇所は修正せず、変換ログに「保留」として記録する
- 可読性向上を目的とした改変は行わない（内容の保持を最優先）

修正許可基準（チェックリスト）
----------------------------
- 行末ハイフンの結合、単語分割の復元
- 明らかなOCR誤認の修正（例: l↔1, O↔0 など、原文で確認できるもの）
- 重複したヘッダ/フッタの削除
- 明確なレイアウト由来の空白/改行の整理
- 不明確な場合は「修正しない」が既定

検証・レビュー手順（必須）
------------------------
- 置換単位ごとに `result.raw.md` と差分を確認する
- 修正箇所は変換ログに「根拠」と「判断理由」を記録する
- サンプル検査は「重要文献」＋「ランダム」から最低5件を選ぶ
- 問題があれば当該Keyは保留リストへ移動し、再OCRまたは原本確認へ戻す

フェーズ（継続追加に対応）
------------------------
1. 対応表の作成（初回＋定期更新）
   - `paper/ocr_references/*.md` と `paper/pdf_extractor/outputs/*/result.md` のKeyを突合
   - 「両方あるKey / OCRのみ / outputsのみ」を継続的に更新
2. 置換作業（増分）
   - 両方あるKey: OCR本文を整形→`outputs/<Key>/result.md` に上書き
   - OCRのみ: `outputs/<Key>/result.md` を新規作成
   - outputsのみ: 置換対象外として保留リスト化（後日判断）
3. 数式プレースホルダ化（都度）
   - `[[EQN:(番号)]]` で統一、未番号は `[[EQN:unnumbered]]`
4. 完了確認（スプリント単位）
   - 追加分Keyの整合を確認
   - 重要文献はサンプル確認（数式位置・段落分割・見出し）
5. 後処理（凍結後）
   - `paper/ocr_references/` の削除は追加作業が落ち着いた段階で判断
   - `python tools/plan_lint.py` 実行

リスクと緩和策
--------------
- リスク: OCR誤りの「修正しすぎ」で意味が変わる
  - 緩和: 明らかなOCR崩れのみ最小限修正、判断に迷う箇所は原文維持
- リスク: 数式プレースホルダ位置のズレ
  - 緩和: 参照番号と周辺文脈の照合を優先し、位置が曖昧なら注記を残す
- リスク: outputsの上書きによる元データ消失
  - 緩和: 置換前に `result.md` を `result.raw.md` として退避（必要に応じて）

実装チェックリスト
-----------------
- [ ] Key対応表を更新し、分類（両方/OCRのみ/outputsのみ）を整理する
- [ ] 新規追加分のOCR本文を整形し、`outputs/<Key>/result.md` を更新する
- [ ] 数式を `[[EQN:(番号)]]` で置換する
- [ ] 置換後のサンプル検査（段落/参照/数式位置）を実施する
- [ ] 追加作業が落ち着いた時点で `paper/ocr_references/` の削除判断を行う
- [ ] `python tools/plan_lint.py` を実行する

追加ルール（明文化）
-------------------
- 受け入れ基準: Key整合率100%、数式プレースホルダ数の一致、サンプル検査での重大な崩れ無し、修正根拠の記録完了
- 変換ログ: 置換前後の差分ログ、修正箇所の根拠/判断理由メモ、`result.raw.md` の退避有無
- 数式プレースホルダ仕様: `[[EQN:(番号)]]` の表記統一、番号不明時は `[[EQN:unnumbered]]`
- 文章修正の境界: 意味が変わる修正は禁止、OCR誤認が明白な場合のみ修正
- 図表/脚注の扱い: キャプション維持、脚注番号は残し本文と整合
- 置換対象外の扱い: outputsのみは保留リスト化、OCRのみは新規作成方針を明記
- サンプル検査: 代表5件（重要文献+ランダム）の点検項目（段落連結/式位置/見出し）
- 削除タイミング: `paper/ocr_references/` は検査完了・バックアップ後に削除
- 例外対応: 複数論文混在や式番号欠損時の処理ルール

具体的な作業手順（チェックボックス）
--------------------------------
- [ ] 1. Key対応表を作成し、`paper/ocr_references` と `paper/pdf_extractor/outputs` の突合一覧を作る
- [ ] 2. 追加分のKeyを識別し、着手順の優先度（重要文献/頻出参照）を付与する
- [ ] 3. 各Keyごとに `outputs/<Key>/result.md` を `result.raw.md` として退避する
- [ ] 4. OCR本文を読み込み、ヘッダ/フッタ/ページ番号を削除する
- [ ] 5. ハイフン改行・段落分断を整形し、明確なOCR誤認のみ修正する
- [ ] 6. 数式を `[[EQN:(番号)]]` または `[[EQN:unnumbered]]` に置換する
- [ ] 7. `outputs/<Key>/result.md` を置換し、差分ログを記録する
- [ ] 8. 追加分から代表5件をサンプル検査（段落連結/式位置/見出し/脚注）する
- [ ] 9. OCRのみ/outputsのみのKeyを保留リストに整理する
- [ ] 10. 追加作業が落ち着いた時点で `paper/ocr_references/` 削除を判断する
- [ ] 11. `python tools/plan_lint.py` を実行し、結果を記録する

進捗ログ
--------
- 2026-01-04: プラン作成
