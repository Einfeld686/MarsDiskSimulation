# 仕様と実装の数式不一致を直すための修正プラン（先行研究に合わせる）

この文書は、`analysis/equations.md`（仕様）と実装の不一致を、**先行研究（論文）に整合する形**へ収束させるための手順書です。0D 既定経路（`surface.collision_solver="smol"`）を主対象にします。

---

## 1. まず結論（何を合わせるか）

今回の不一致は「仕様が誤っている」場合と「実装が誤っている」場合が混在しています。先行研究との照合の結果、次の方針が妥当です。

- **最大残留質量分率（E.033）は、仕様も実装も、先行研究の式に合わせて修正する。**  
  現状のクリップ（大きな衝突エネルギーで 0 に落ちる）や、分岐点 φ=1 は、先行研究の推奨形と一致しません。
- **`solve_c_eq`（E.021）周りは、単位定義を一本化し、Numba 経路の引数バグを直す。**  
  いまのままだと NumPy/Numba で e の基準値が変わってしまいます。
- **表層 Σ の上限（E.007）と Q_pr のフォールバック（E.004/E.012）は、仕様を「どの近似を採るか」まで明示し直してから、実装を追従させる。**  
  どちらもモデル化の選択が含まれるため、仕様に「採用する近似」を書き切った方が後戻りが減ります。

---

## 2. 先行研究と照合したポイント（要点だけ）

### 2.1 最大残留質量分率 f_LR（E.033）
「衝突後に一番大きく残る塊の割合」を、最大残留質量分率（largest remnant mass fraction）と呼びます。先行研究では、破壊閾値で規格化した衝突エネルギー φ に対して、次の **2本立て**（直線＋高エネルギーでの冪）を推奨しています。

- 0 < φ < 1.8 では「普遍則」と呼ばれる直線：  
  \[
  \frac{M_{\mathrm{lr}}}{M_{\mathrm{tot}}}
  =-0.5\left(\phi-1\right)+0.5
  \]
- φ ≥ 1.8 では「超壊滅」領域として冪乗則：  
  \[
  \frac{M_{\mathrm{lr}}}{M_{\mathrm{tot}}}
  = \frac{0.1}{1.8^{\eta}}\,\phi^{\eta},
  \quad \eta\approx-1.5
  \]

ここで φ は \(\phi=Q_R/Q_{\mathrm{RD}}^*\)（破壊閾値で割った比衝突エネルギー）です。分岐点 1.8 と係数 0.1 は、2つの式が滑らかにつながるように選ばれています。

### 2.2 放射圧効率 Q_pr（E.004/E.012）
放射圧の効きやすさを表す係数を、放射圧効率（radiation pressure efficiency）Q_pr と呼びます。古典的なレビューでは、Q_pr は吸収と散乱から構成され、完全吸収なら Q_pr=1 になることが明示されています。  
このため「テーブルが無いときは Q_pr=1」という灰色体近似は、少なくとも限界ケースとしては先行研究に整合します。

### 2.3 e と i の単位（E.021 の背景）
平均偏心率 e と軌道傾斜 I（または i）は**無次元**です。先行研究のレビューでも、衝突時間などに e（無次元）が入る形で記述されています。  
したがって、実装側で「速度（m/s）」を扱う変数を置くなら、それは e とは別物として定義し、e との関係（例：e = v_rel / v_K）を仕様に明記しておく必要があります。

---

## 3. 修正プラン（タスク単位）

以下では、既存の不一致整理（`20251227_equations_mismatch_summary.md`）の項目番号（E.033 など）に合わせて、**仕様→実装→テスト**の順で手順を置きます。

### 3.1 E.033 最大残留質量分率：仕様・実装を先行研究に合わせる

#### 3.1.1 仕様（`analysis/equations.md`）の修正
1つめの作業は、`analysis/equations.md` の E.033 を、上記の **φ=1.8 分岐**の形へ差し替えることです。現状の「φ≥1 で 0.5 φ^-1.5」という形は、先行研究の係数・分岐点と一致しません。

仕様には、次の3点も一緒に書きます。

- φ の定義（Q_R と Q*_RD の定義、単位）
- 1.8 と 0.1 が「連続条件から来る」こと
- η の採用値（-1.5 を既定とし、将来の感度分析用に設定値化できる余地）

#### 3.1.2 実装（コード）の修正
対象は整理メモにある2箇所です。

- `marsdisk/physics/fragments.py`：`largest_remnant_fraction_array`
- `marsdisk/physics/_numba_kernels.py`：`compute_largest_remnant_mass_fraction_F2`

実装方針は次です。

- φ < 1.8：`f_lr = 1 - 0.5*phi`（＝普遍則）
- φ ≥ 1.8：`f_lr = 0.1 * (phi/1.8)**eta`（eta=-1.5）
- クリップは **[0,1] の外に出ないための最小限**に留める（高エネルギー側を 0 に潰さない）

また、呼び出し元が「f_lr=0 を前提にしている」可能性があるので、以下を同時に確認します。

- f_lr が 0 に近づく場合の最小粒子数や質量の扱い（ゼロ割回避）
- 分裂生成物の質量保存（`Mtot` との差分が散逸扱いになっていないか）

#### 3.1.3 テスト（回帰防止）
`tests/` に、次の性質テストを追加します（値テストは要点に絞ります）。

- 連続性：φ=1.8 の両側で f_lr が一致する
- 代表点：φ=1 → f_lr=0.5、φ=1.8 → f_lr=0.1
- 単調性：φ が増えると f_lr は減る（少なくとも 0<φ<十分大きい範囲で）

---

### 3.2 E.021 / Numba c_eq：単位の定義を確定し、Numba 経路を一致させる

ここは「仕様に書いてある c の単位」と「実装で使っている c の意味」が噛み合っていないことが根本です。先に仕様を確定し、その仕様に沿って実装を整えます。

#### 3.2.1 仕様の決め方（どちらかに寄せる）
選択肢は2つあります。どちらでも動きますが、後段（衝突速度やスケールハイト）で混乱が少ないのは A です。

**A. c は相対速度（m/s）として定義する（推奨）**  
- c を「ランダム相対速度 v_rel」と定義し、e とは `e = c / v_K` で結ぶ。  
- `wyatt_eq` がすでに `e=c/v_K` を使っているため、変更量が少ない。

**B. c は無次元（=e）として定義する**  
- c を e そのものとして扱い、`wyatt_eq` の `e=c/v_K` を `e=c` に変更する。  
- 速度が必要な場所では `v_rel = e v_K` を都度計算する。

このプランでは A を前提に進めます。もし B を選ぶ場合も、作業の流れは同じで、置き換える場所だけが変わります。

#### 3.2.2 実装修正（NumPy/Numba 一致）
整理メモで指摘されている通り、Numba 経路は `e_base` の渡し方が誤っています。具体的には、

- NumPy 経路：`e_base = c0 / v_K`（無次元）  
- Numba 経路：`e_base = c0`（速度）を渡してしまっている

という差があり、同じ入力でも別の解に収束し得ます。

修正内容はシンプルで、Numba 経路も `e_base = c0 / v_K` を渡すように直します（`marsdisk/physics/dynamics.py` の `solve_c_eq_numba` 側）。

#### 3.2.3 仕様（`analysis/equations.md`）の追記
E.021 には、次を追記します。

- c の単位（m/s）と、そのとき e をどう計算するか（e=c/v_K）
- `solve_c_eq` が返すもの（c_eq）を、後段の式がどう解釈するか

この追記が無いと、今後また「式は無次元、本文は m/s」のようなズレが再発します。

#### 3.2.4 テスト
ここは「NumPy と Numba の一致」を確認する回帰テストが効きます。テストでは、

- 同一入力で `solve_c_eq`（NumPy）と `solve_c_eq_numba`（Numba）が、許容誤差内で一致する
- `v_K` を変えたとき、e=c/v_K が想定通りスケールする

を確認します。

---

### 3.3 E.007 表層 Σ の上限：仕様に「近似の採用」を書き、実装を合わせる

この項目は、どちらが正しいというより「モデル化の選択」です。ここで曖昧なままにすると、後で物理過程（遮蔽・放射圧・昇華）を足したときに解釈がぶれます。

仕様側の候補は2つです。

**案1：Σ_surf を「露出している層」だとみなし、Σ_{τ=1} で上限を切る**  
- Σ_{τ=1}=1/κ_eff を超えた分は、表層ではなく内部に溜まると扱う。  
- 仕様の `min(…, Σ_{τ=1})` を残し、実装にクリップを入れる。

**案2：Σ_surf を「実際の表層面密度」とし、遮蔽は Φ(τ) で連続的に表現する（現状に近い）**  
- 上限クリップはしない。Σ_{τ=1} は診断量としてのみ扱う。  
- 仕様の `min` を削除し、「遮蔽は Φ(τ) で扱う」と明記する。

このプロジェクトは遮蔽関数 Φ(τ) を別途持っているため、二重に効かせないという意味では **案2 の方が一貫**します。  
ただし、案2 を採るなら「Φ(τ) が τ≫1 で効き方を持つ」こと（露出割合が 1/τ 程度に落ちる等）が仕様に書かれている必要があります。

実作業としては、

1. `analysis/equations.md` 側で案1/案2を選び、E.007 を確定する  
2. それに合わせて `marsdisk/physics/surface.py`（`step_surface_density_S1`）を修正する  
3. τ≫1 の極限で、表層流出 Ṁ_out や昇華シンクが暴走しないことを小さいテストで確認する  

という順が安全です。

---

### 3.4 E.004 / E.012 Q_pr：フォールバック方針を仕様化し、実装へ反映する

ここも「モデル化の選択」が含まれますが、先行研究上は **Q_pr=1 は自然な近似**です。したがって、仕様に書かれている「テーブルが無い場合は 1」を復活させる方向を推奨します。

#### 3.4.1 仕様の確定
`analysis/equations.md` には次を明記します。

- テーブルは「波長・温度平均された Q_pr」を与えるが、無い場合は灰色体近似で Q_pr=1 を使う
- ただし、研究上の再現性のために「テーブル必須モード」を設定で選べる余地を残す

#### 3.4.2 実装修正
`marsdisk/physics/radiation.py` の `_resolve_qpr` を、次の挙動にします。

- 明示指定がある → それを使う
- テーブルがロード済み → 補間して使う
- それ以外 → 既定は 1（ただし strict 設定なら例外）

この変更は、CI や最小実行で「テーブルが無いだけで落ちる」状態を避けられます。

#### 3.4.3 テスト
テストは 2 本立てにします。

- テーブル無しで実行しても例外にならず、Q_pr=1 が返る（既定モード）
- strict モードでは例外になる（研究用途の再現性確保）

---

## 4. 実装の順序（作業を崩さない並べ方）

変更の影響が大きい順に、しかしデバッグしやすい順に並べます。

1. **E.033（f_LR）**：仕様と実装とテストを同時に修正（衝突生成が全体へ波及するため）
2. **E.021/Numba（c_eq）**：NumPy/Numba の一致を先に作る（検証の土台）
3. **E.004/E.012（Q_pr）**：フォールバック導入（実行性の改善と仕様一致）
4. **E.007（Σ 上限）**：最後に仕様選択を固めて反映（物理解釈が絡むため）

---

## 4.5 実装プラン（チェックリスト）

### 事前決定（仕様の選択）
- [x] E.021: 速度分散 $c$ を **速度 (m/s)** として扱うか、**無次元 (e と同義)** とするか決定する。
- [x] E.007: $\Sigma_{\tau=1}$ クリップを **採用する** か **採用しない** か決定する。
- [x] E.004/E.012: Q_pr のフォールバックを **既定で許容** するか、**strict（テーブル必須）**にするか決定する。

### 仕様（`analysis/equations.md`）更新
- [x] E.033: $\phi=1.8$ 分岐の $f_{\mathrm{LR}}$ 式と係数（0.1, $\eta=-1.5$）を明文化する。
- [x] E.021: $c$ の単位と $e$ への変換規則（例: $e=c/v_K$）を明記する。
- [x] E.007: 選んだ $\Sigma_{\tau=1}$ 方針（クリップ or 非クリップ）を式として確定する。
- [x] E.004/E.012: Q_pr のフォールバック方針を明示する（灰色体=1 or strict）。

### 実装（コード）更新
- [x] E.033: `marsdisk/physics/fragments.py` の `largest_remnant_fraction_array` と `compute_largest_remnant_mass_fraction_F2` を $\phi=1.8$ の分岐式へ更新する。
- [x] E.021: `marsdisk/physics/_numba_kernels.py` の `compute_kernel_e_i_H_numba` フォールバックを NumPy 経路と一致させる。
- [x] E.007: `marsdisk/physics/surface.py` にクリップを入れるか、もしくは「クリップしない」前提に合わせて整理する。
- [x] E.004/E.012: `marsdisk/physics/radiation.py` の `_resolve_qpr` にフォールバックまたは strict を実装する（決定内容に従う）。

### テスト追加・更新
- [x] E.033: $f_{\mathrm{LR}}$ の連続性（$\phi=1.8$）と代表点（$\phi=1,1.8$）のテストを追加する。
- [x] E.021: NumPy/Numba で $c$ と $e$ の整合が取れることを検証する。
- [x] E.004/E.012: フォールバック有効/strict の両方で挙動を確認するテストを追加する。

### 仕上げ（検証）
- [x] 0D の短時間スモーク実行でクラッシュがないことを確認する。
- [x] 主要な pytest サブセットを通す（単体・統合の最低限）。

---

## 5. 受け入れ条件（Done の定義）

最後に、直ったと言える条件を、観測可能な形で置いておきます。

- `analysis/equations.md` の各式が、コードと一致している（少なくとも E.033 / E.021 / E.004 / E.007）
- 0D スモークテストが再現可能に通る（例：README にある短時間 run）
- NumPy と Numba の経路が、同一入力で一致する（`solve_c_eq`）
- f_LR の代表点（φ=1,1.8）と連続性テストが通る

---

## 6. 参考文献（このプランが依拠する先行研究）
- Stewart, S. T. & Leinhardt, Z. M. “Diverse Giant Impact Outcomes …”（式13,14）, arXiv:1109.4588（本文中で LS12 として 2012 を参照）
- Burns, J. A., Lamy, P. L., & Soter, S. “Radiation Forces on Small Particles …” Icarus 40 (1979), DOI: 10.1016/0019-1035(79)90050-2
- Wyatt, M. C. “Evolution of Debris Disks” ARA&A 46 (2008), DOI: 10.1146/annurev.astro.45.051806.110525
