# 20251218_energy_bookkeeping_plan.md の評価メモ（エネルギー簿記・反発係数対応）

作成日: 2025-12-17  
対象: `docs/plan/20251218_energy_bookkeeping_plan.md` と、その出典である `collision_energy_conservation_requirements.md`

---

## 1. この計画が目指していること（事実）

計画書は、0D Smoluchowski 衝突ステップに対して次の 3 点を入れる方針を明示しています。

- 衝突で失われる（散逸する）運動エネルギー量を、各ステップでログに残す。  
- 速度減衰（離心率 e / 軌道傾斜 i の更新）と、エネルギー散逸のログが「同じ方向」を向くように、反発係数を導入する。  
- 追加オプションとして、破砕で新しくできる表面を作るのに必要なエネルギーから、作り得る最小粒径を見積もる（表面エネルギー制約）。

計画の「実装姿勢」として、Numba の JIT（Just-In-Time コンパイル）経路で衝突カーネルと同時に簿記統計を集計し、Numba 無効時は NumPy ベクトル化 + 上三角集計で代替する、という方針が明記されています。

---

## 2. 定義されている数式・ログ量（事実）

### 2.1 衝突 1 回あたりの相対運動エネルギー

計画は、ペア (i, j) ごとの相対運動エネルギーを

\[
E_{\mathrm{rel},ij} = \frac{1}{2}\,\mu_{ij}\,v_{ij}^2
\]

で置き、これを衝突率（衝突フラックス行列）で重み付けしてステップ量に積分することを前提にしています。

### 2.2 `f_ke` の位置づけ（重要）

要件文書側では、`f_ke` は「衝突後に散逸されずに残る運動エネルギーの割合」として定義されており、

\[
E_{\mathrm{ret},ij} = f_{\mathrm{ke},ij}\,E_{\mathrm{rel},ij},\qquad
E_{\mathrm{diss},ij} = (1-f_{\mathrm{ke},ij})\,E_{\mathrm{rel},ij}
\]

を採用しています。

※計画本文の見出しが「散逸率 f_ke」になっている点は、定義と呼び方が一致していないので後述します。

### 2.3 侵食（クレーター）と壊滅的破砕の分岐

最大破片（最大残骸）の質量分率を `F_lf`（実装では「最大残留分率」系の値）として、

- `F_lf > 0.5` を侵食（クレーター）側  
- `F_lf <= 0.5` を壊滅的破砕側

として `f_ke_cratering` と `f_ke_fragmentation` を使い分ける、という仕様です。

### 2.4 e/i の減衰更新（提案式）

計画は減衰時定数を

\[
t_{\mathrm{damp}} = \frac{t_{\mathrm{coll}}}{\varepsilon^2}
\]

として、指数緩和で

\[
e_{n+1} = e_n + \left(\frac{c_{\mathrm{eq}}}{v_K} - e_n\right)
\left(1 - \exp\left(-\frac{\Delta t}{t_{\mathrm{damp}}}\right)\right)
\]

（i も同形）を適用する案になっています。

### 2.5 表面エネルギー制約による最小粒径（オプション）

\[
s_{\min,\mathrm{surf}}
= \left[ \frac{6\gamma(\alpha - 3)}{\eta\,\rho\,v_{\mathrm{rel}}^2} \right]^2
\,s_{\max}^{\alpha - 5}
\quad (\alpha \ne 5)
\]

を計算し、既存の最小粒径（ブローアウト、昇華床など）と比較して有効最小粒径を

\[
s_{\min,\mathrm{eff}} = \max(\text{config},\ \text{blowout},\ \text{floor\_dynamic},\ \text{surface\_energy})
\]

で決める、という統合方法が提案されています。

---

## 3. 良い点（評価）

この計画の良い点は、実装の「見通し」と「検証のしかた」が具体的で、後から追える形になっているところです。主に次の 4 点が効いています。

1) **Numba と NumPy 代替の一致を最初から要件化している**  
　`F_lf` と `f_ke` の行列を Python 側で作り、Numba 経路と Fallback 経路が同じ入力を使う、という方針は、差分が出にくくテストもしやすいです。

2) **ログ（run.parquet / energy_budget.csv）に何を入れるかが具体的**  
　「後で比較できる」粒度で列設計が書かれており、解析作業の手戻りが減ります。

3) **数値チェック（E_diss + E_ret - E_rel）を明示している**  
　演算上の取り違え（上三角 vs 全行列、dt を掛け忘れる、など）を機械的に検出できます。

4) **表面エネルギー制約をオプション扱いにしている**  
　既存計算を壊さずに感度試験ができるので、導入の順序として安全です。

---

## 4. 気になる点と修正提案（評価）

ここからは「実装するときに事故が起きやすい点」です。物理モデルの是非と、実装上の混乱を分けて書きます。

### 4.1 `f_ke` の見出し名（「散逸率」）が定義と逆

要件側の定義は「残る割合」ですが、計画書の見出しが「散逸率」になっています。  
このままだと、実装者や将来の読み手が **(1-f_ke)** を掛けるのか **f_ke** を掛けるのかで迷います。

**提案**: 少なくともドキュメント上は、見出しを「残存率（非散逸率）」の意味が分かる表現に変え、式を常に
\(E_{\mathrm{ret}} = f_{\mathrm{ke}} E_{\mathrm{rel}}\) と書いておくのが安全です。

### 4.2 e/i 減衰の時定数 `t_damp = t_coll / eps^2` は単調性が逆になり得る

ここは物理モデルの部分です。反発係数 \(\varepsilon\) を「衝突後の相対速度がどれだけ残るか」と読むと、\(\varepsilon\to 1\) では散逸がほぼゼロになります。  
この場合、減衰は弱くなり、極限では「減衰しない」に近づくのが直感に合います。

しかし提案式だと \(\varepsilon=1\) でも \(t_{\mathrm{damp}}=t_{\mathrm{coll}}\) で有限です。さらに \(\varepsilon\) が小さいほど \(t_{\mathrm{damp}}\) が大きくなるので、**より非弾性なほど減衰が遅くなる** 方向になります。

**提案（最小限）**:  
この式は「方向合わせの暫定」と明記した上で、減衰を既定で無効（既に enable_e_damping=false）にしておくのは妥当です。

**提案（物理を優先するなら）**:  
衝突 1 回あたりのエネルギー損失が \((1-\varepsilon^2)\) に比例する、という教科書的な関係に基づくなら、
\[
t_{\mathrm{damp}} \propto \frac{t_{\mathrm{coll}}}{\max(1-\varepsilon^2,\ \varepsilon_{\mathrm{floor}})}
\]
のように、\(\varepsilon\to 1\) で発散する形の方が自然です（\(\varepsilon_{\mathrm{floor}}\) は 0 除算回避）。  
この変更を入れると、`solve_c_eq` 側で既に使っている \(1-\varepsilon^2\) の構造とも揃います。

### 4.3 `n_cratering / n_fragmentation` の意味が曖昧

計画は「イベント数」と書いていますが、設計を見る限り「上三角のセル数」を数える実装になりやすいです。  
もしそうだと、衝突率がほぼゼロの (i,j) も 1 件として数えるため、「実際に起きている衝突の割合」としては意味が薄くなります。

**提案**: 次のどちらかに寄せるのが安全です。

- 本当にセル数を出したいなら、列名と説明を「セル数」「組み合わせ数」に寄せる。  
- 衝突の割合を出したいなら、衝突率重み付きで
  \[
  f_{\mathrm{crat}}^{(C)} =
  \frac{\sum_{i\le j} C_{ij}\,\mathbf{1}_{\mathrm{crat}}}{\sum_{i\le j} C_{ij}}
  \]
  のような比率を主とし、必要なら `C_ij*dt` を掛けた「ステップあたり衝突回数（面積あたり）」も併記する。

### 4.4 `f_ke_mean` は「何で重み付けた平均か」を固定しておく

計画では「衝突レート重み付き平均」が想定されていますが、エネルギー簿記の文脈で見ると、エネルギー重み付き平均の方が直感的です。

**提案**: すでに `E_retained_step` と `E_rel_step` を出すので、追加コストなしで

\[
\bar f_{\mathrm{ke}}^{(E)} = \frac{E_{\mathrm{retained,step}}}{E_{\mathrm{rel,step}}}
\]

を計算できます。  
これを `f_ke_energy` のように別名で出しておくと、`f_ke_mean`（衝突率重み）と混ざりません。

### 4.5 表面エネルギー制約の境界条件（α の範囲）が要確認

式は \((\alpha-3)\) を含むので、\(\alpha\le 3\) のとき計算結果が負になり得ます。  
一般に破片分布の指数は \(\alpha\approx 3.5\) のような範囲で使われることが多いので、実際の設定では問題が出ない可能性は高いですが、コード側でガードがあると安全です。

**提案**: `surface_energy.enabled` のときでも、
- \(\alpha\le 3\) なら「制約なし」とみなして `s_min_surface_energy = 0` にする、などの処理を入れる。  
- 計算した `s_min_surface_energy` が `s_max` を超えた場合の扱い（「破砕で最小粒径を作れない」）をログに残す。

### 4.6 上三角和（Σ_{i≤j}）と 1/2 の取り扱いは、コードに合わせて一度だけ確定する

計画は「上三角和を使うので (1+δ) の復元は不要」と書いており、既存の `compute_prod_subblow_area_rate_C2` が上三角和で実装されている点と整合します。  
一方、ドキュメント上は `C_ij` の定義と「1/2 Σ」の形が混在しているので、実装前に「どちらの規約の C を使っているか」をコードの実体で確定させる必要があります。

**提案**: 単純な 2 ビン・2 ペアの toy case を用意し、手計算の衝突回数と一致する方の規約に統一してください。ここを曖昧にしたまま実装すると、エネルギーが 2 倍（または 1/2）ずれます。

### 4.7 Numba カーネルの戻り値を dict にする案は、そのままだと難しい可能性がある

計画の API 例は `energy_stats: dict` を返す形ですが、Numba の nopython モードでは Python の dict を返せないケースが多いです。

**提案**: 返り値は
- 固定長のタプル（例: `E_rel, E_diss, E_ret, fke_mean, ...`）  
- あるいは長さ固定の 1D 配列（stats vector）を埋める

の方が実装が楽で、型も安定します。

---

## 5. 実装・検証の追加提案（評価）

計画の検証項目は十分にありますが、事故を減らすという観点で、次の 4 つを追加すると効果が高いです。

1) **dt の積分の有無を必ずテストする**（rate と step の混同が一番起きやすい）  
2) **極限テスト**: \(\varepsilon=1\)（散逸ゼロ）と \(\varepsilon\to 0\)（強い散逸）で、符号と単調性が崩れないかを見る  
3) **Numba/Fallback 一致**: toy case を固定入力で比較し、bit-level までは求めず相対誤差の許容幅を決める  
4) **α の境界**: \(\alpha=3\), \(3.5\), \(5\) 近傍で `s_min_surface_energy` が NaN/inf にならないことを確認する

---

## 6. まとめ（評価）

- 計画は、ログの設計、Numba/Fallback の一貫性、数値検証の設計が揃っており、「実装して動かす」までの道筋は明確です。  
- いちばん注意すべきなのは、(a) `f_ke` の呼び方と定義のズレ、(b) `t_damp = t_coll/eps^2` の単調性（\(\varepsilon\to 1\) で減衰が残ってしまう）です。ここは後から修正すると解析結果の解釈が大きく揺れるので、導入前に整理した方が安全です。  
- 表面エネルギー制約はオプション導入になっているので、境界条件（\(\alpha\le 3\), \(\alpha\approx 5\)）のガードを追加すれば、感度試験の道具として使いやすくなります。

---

## 参考（本文の理解に使った出典）

- collision_energy_conservation_requirements.md（本プロジェクトの要件メモ）
- 20251218_energy_bookkeeping_plan.md（本評価対象）
- Thébault, P. et al. (2003) の衝突モデル（f_ke の定義）
- Krijt, S. & Kama, M. (2014) の表面エネルギー制約（最小粒径の下限）
- 反発係数と衝突の運動エネルギー損失の一般的関係（教科書レベルの力学）
