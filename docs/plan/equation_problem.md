## 1 近点速度の式が標準形と一致しない（E.020b）

`equations.md` では、近点通過時の速度を

[
v_{\mathrm{peri}} = \frac{v_K}{\sqrt{1-e}}
]

としています。
一方、軌道力学の標準式（vis-viva 方程式）から近点速度を評価すると、

* vis-viva：(v^2=\mu\left(2/r-1/a\right))
* 近点距離：(r_{\mathrm{peri}}=a(1-e))
* したがって近点速度：(;v_{\mathrm{peri}}=\sqrt{\mu/a}\sqrt{(1+e)/(1-e)})

となり、一般には **(\sqrt{1+e})** の因子が入ります。
`equations.md` の式は、この因子を落としている形に見えます（ただし、もし `v_K` をどの半径で定義しているかが特別であれば解釈が変わるので、まずそこを明文化する必要があります）。

**影響**：この式は速度（さらに速度二乗）を介して衝突エネルギーや破砕、表面エネルギー制約（後述 E.053 の (v_{\mathrm{rel}}^2)）に直結します。例えば (e=0.5) なら、標準形に対して速度は (\sqrt{1+e}=\sqrt{1.5}) だけ小さくなり、速度二乗は 1.5 倍の差になります。

---

## 2 表面エネルギー制約による最小粒径の式が Krijt & Kama (2014) と形が合わない（E.053）

`equations.md` の E.053 は、Krijt & Kama 型として

[
s_{\min,\mathrm{surf}} =
\left[\frac{6\gamma(\alpha-3)}{\eta\rho v_{\mathrm{rel}}^2}\right]^2
s_{\max}^{\alpha-5}
\quad(\alpha\ne 5)
]

を使っています。

しかし、Krijt & Kama (2014) の本文では、まず一般式（質量・表面積）を示し（Eqs.2–3）、そこから **(\alpha=3.5)** の特別な場合として

[
s_{\min}=
\left(\frac{24\gamma s_0}{\eta\rho s_0 v_{\mathrm{rel}}^2 + 24\gamma}\right)^2
s_{\max}^{-1}
]

を与えています（Eq.4）。

この比較から、少なくとも次の点が一致していません。

* **(s_{\max}) のべき**：Krijt & Kama の Eq.4 は (s_{\max}^{-1}) ですが、`equations.md` の式を (\alpha=3.5) に入れると (s_{\max}^{-1.5}) になります。
* **係数と、低速度での飽和項（(+24\gamma)）**：Krijt & Kama は (\eta\rho s_0 v^2) に対して (+24\gamma) を足した形で、低速度側で式が発散しないようになっています。`equations.md` の式はこの構造が見当たりません。

**影響**：最小粒径の下限は PSD の下端を直接動かすので、光学的厚さ、放射圧ブローアウト、昇華などの「小さい粒に支配される量」がまとめて変わります。さらに E.053 は (v_{\mathrm{rel}}) に E.020b の近点速度を使う設計になっているため、E.020b の式の誤差がここにも増幅して入ります。

---

## 3 Smoluchowski 方程式（E.010）と衝突カーネル（E.024）の「定義」が噛み合っていない

`equations.md` の E.010 は、Smoluchowski 方程式を

[
\dot{N}*k = \tfrac{1}{2}\sum*{i,j} K_{ij}N_iN_jY_{kij} - N_k\sum_j K_{kj}N_j + f_k
]

と書き、その後の IMEX 更新では (\Lambda_i=\sum_j C_{ij}) を使っています。

ところが E.024 では、別途

[
C_{ij}=\frac{N_iN_j}{1+\delta_{ij}}\frac{\pi(s_i+s_j)^2 v_{ij}}{\sqrt{2\pi}H_{ij}}
]

と定義しています。

ここで問題になるのは、**E.010 の「損失項」は “(N_k) ×（他ビン密度で重み付けした衝突頻度）” になっている**のに対し、E.024 の (C_{ij}) は **既に (N_iN_j) を含んでいる**ため、同じ記号のまま扱うと「どこで (N) を掛けるか」が二重化・欠落し得る点です。

一般的な離散 Smoluchowski でも、衝突頻度関数（カーネル）を (\beta_{ij}) とすると、基本形は **(\beta_{ij} n_i n_j)** のように “カーネル × 密度 × 密度” で書かれます（損失は (n_k\sum_i\beta_{ik}n_i)）。
この構造に照らすと、E.010 で (\Lambda_i) を「時間スケール（1/Λ）」に使うなら、(\Lambda_i) は通常 **(N_i) を含まない**形（例：(\sum_j K_{ij}N_j)）として定義しないと単位・意味が揃いません。

**補足（同じ根の問題）**：E.046 では (N_k) を m(^{-3})、(K_{ij}) を m(^3) s(^{-1}) としており、E.010（表面数密度 m(^{-2})）と前提が変わっています。
この「表面密度なのか体積密度なのか」「カーネルは何の次元か」をまず一つに固定しないと、先行研究との照合以前に、式の意味が揺れたままになります。

---

## 4 “式” というより「単位・変数定義」が途中で変わっている箇所がある（E.046 ほか）

3. と重なりますが、`equations.md` 内で

* 同じ “PSD の状態量” が m(^{-2}) と m(^{-3}) で書き分けられる
* 衝突カーネルが (C_{ij}) と (K_{ij}) で混在し、どちらが “密度込み” なのかが節によって変わる

という状態が見えます。
これは文献の式と合う/合わない以前に、**実装が正しくても説明が誤解を生む**し、逆に **説明通りに実装していた場合は衝突率や時間スケールが誤る**可能性が出ます。

---

以下は、リポジトリ内の **「現状の実装式」まとめ（equations.md）** と **参照文献一覧（bibliography.md）** を起点に、式の定義・前提が先行研究と一致していない（または一致していると確認できない）箇所を抜き出したものです。
（注：先行研究の本文すべてを網羅照合したというより、「公開されている本文・プレプリントで確認できた範囲」と、equations.md 側の注記に基づく整理です。）

---

## 5 定義や符号が違うため、そのままだと別の量になっている可能性が高い箇所

* **(E.018) 昇華の質量フラックスで ((P_{\mathrm{sat}}-P_{\mathrm{gas}})\lt0) を 0 に丸めており、凝結が起きない実装になっている**
HKL（気体運動論に基づく）式は、一般に「平衡圧と周囲圧の差」に比例する“正負つきの正味フラックス”として書かれます。差が負なら凝結（逆向き）になります。
ところが現状実装では、HKL 分岐で **負の ((P_{\mathrm{sat}}-P_{\mathrm{gas}})) を 0 に丸める**と明記されています。
そのため、蒸気が十分に溜まる条件（(P_{\mathrm{gas}}) が無視できない条件）では、先行研究の式が含む「凝結による戻り」を意図的に捨てており、**式の意味が変わっています**。

---

## 6 先行研究にない（または前提を外れる）“安全装置・近似”が入っている箇所

* **(E.018) HKL を使えないとき、単なる指数関数にフォールバックする**
HKL が使えない場合に (J(T)=\exp((T-T_{\mathrm{sub}})/dT)) に落とす分岐があり、これは先行研究の昇華式というより「計算を継続するための仮の形」です。
先行研究の式と比べると、**温度依存の形も単位の意味も一致しません**（少なくとも equations.md 上はそう読めます）。

---

## 7 「同一形を確認できない」だが、少なくとも一部は文献で裏が取れる／残りは要確認の箇所

* **(E.020) 相対速度 (v_{ij}=v_K\sqrt{1.25e^2+i^2}) のうち、(e) 側の 1.25 は文献で根拠が確認できるが、(i) との合成形は要確認**
equations.md では「係数 1.25 の置き方は実装上の選択で、同一形を明示した文献は未確認」とされています。
ただし Mustill & Wyatt (2009) では、ランダム化した小さな離心率の集団で平均相対速度を (v_{\mathrm{rel}}=c,e,v_{\mathrm{kep}}) と書き、**レイリー分布なら (c=\sqrt{5/4})** と明記しています。([w.astro.berkeley.edu][1])
ここまで見ると、少なくとも **(i=0) の極限では実装の (e) 項（(\sqrt{1.25},e)）は文献の形と一致**します。
一方で、Mustill & Wyatt (2009) 自身が「(c) は定義や分布に依存する」「傾斜がある場合は傾斜も効く」と注意しており、([w.astro.berkeley.edu][1])
**(+i^2) をどの係数で、どの定義の (i) と合成するのが“先行研究と同じ”か**は、追加の裏取りが必要です。

* **(E.024/E.010 周辺) “衝突カーネル”の記法と単位が、文献で一般的な分解（カーネルと数密度の積）と 1 対 1 で対応しない可能性**
equations.md の式では (C_{ij}) の定義に (N_iN_j) が入っているのに、名称として “kernel element” と書かれています。
この状態だと、先行研究側が「カーネル (K_{ij})」と「衝突率 (K_{ij}N_iN_j)」を分けて書いている場合に、**式の照合が見かけ上ずれます**。ここは“物理が違う”というより、“記号の対応付けが曖昧になる”タイプの不整合です。

* **(surface_ode 系) 既定では使わないレガシー式に、先行研究の仮定と混ざりやすいスイッチが残っている**
`surface_ode` は既定ではなく、対照実験用の簡略版として残している、と明記されています。
ここに Takeuchi & Lin (2003) の gas-rich 仮定の式を試すスイッチがあり、プロジェクトでは既定で無効、と書かれています。
つまり「式そのもの」よりも、「異なる前提の式が同じ枠に並ぶ」点で、先行研究との整合確認を難しくする要因になっています。

---

## 8 具体的な更新案（equations.md 反映の方針）

以下は **analysis/equations.md を実装に合わせて修正する** 前提の具体案です。基本は「説明の整合」を優先しますが、**E.020b は vis‑viva に合わせるため実装側も更新対象**とします。

1. **(E.020b) 近点速度の式**
   - **決定**: vis‑viva の標準形に合わせて **v_peri = v_K * √((1+e)/(1−e))** を採用する。
   - **追記**: `v_K = √(GM/a)` を明記し、0D の代表半径は **a とみなす**ことを記述する。
   - **実装対応**: `v_rel_pericenter` の式を √(1+e) を含む形に変更し、影響箇所（E.053 など）を点検する。

2. **(E.053) 表面エネルギー制約の最小粒径**
   - **方針**: Krijt & Kama (2014) の **原典式（Eqs.2–4）を再確認**し、採用形（一般式か α=3.5 特例か）を明示する。
   - **更新案**: 原典が Eq.4（α=3.5 特例）を意図する場合は **s_max^{-1}** と **(+24γ)** 飽和項を明記し、現行式との差分を注記する。
   - **不一致時**: 原典の解釈が曖昧な場合は `UNKNOWN_REF_REQUESTS` に登録し、暫定的に「実装簡略形」である旨を明記する。

3. **(E.010 / E.024) Smoluchowski の記号整理**
   - **決定**: **N を含む `C_ij` を衝突率（面密度ベース）として統一**し、E.010 は `C_ij` で記述する。
   - **追記**: `K_ij` を使う場合は **`C_ij/(N_i N_j)` の密度抜きカーネル**として定義し、記号の対応を明示する。
   - **単位整理**: `C_ij` の単位を **m^-2 s^-1**（衝突率/面積/時間）として明記する。

4. **(E.046) 体積密度/表面密度の不整合**
   - **決定**: **表面密度（m^-2）に統一**し、E.024 の `C_ij` と単位整合させる。
   - **追記**: 体積密度系を併記する場合は **H を含む変換式**を脚注として追加する。

5. **(E.018) 昇華フラックスのクランプとフォールバック**
   - **推奨**: gas‑poor 既定では **負の (P_sat−P_gas) を 0 にクランプ**する方針を明記（凝結を扱わない前提）。
   - **拡張余地**: gas‑rich/高 P_gas の感度試験向けに **凝結を許す別モード**の余地を注記（コード対応は別タスク）。

6. **(surface_ode / TL2003) 適用条件の明確化**
   - **案**: `surface_ode` と TL2003 の関係を **「gas‑rich 前提の補助モデル」** として明文化し、既定は `surface.collision_solver="smol"` であることを強調する（E.007 の注意書きを補強）。

---

## 更新手順（チェックリスト）

以下は **docs/plan/equation_problem.md の指摘を優先**し、analysis/equations.md を実装と整合させるための手順です。

- [x] **E.020b**: vis‑viva の標準形（√(1+e) を含む）へ更新し、`v_K = √(GM/a)` を明記する。  
- [x] **E.053**: Krijt & Kama (2014) 原典式（Eqs.2–4）を再確認し、採用形と差分注記を確定する。  
- [x] **E.010/E.024**: `C_ij`/`K_ij` の定義と単位を統一し、E.010 を `C_ij` ベースで記述する。  
- [x] **E.046**: `N_k` を表面密度（m^-2）に統一し、必要なら H 変換の脚注を追加する。  
- [x] **E.018**: gas‑poor 既定は「負フラックスは 0 にクランプ」と明記し、凝結許容は別モードとして注記する。  
- [x] **surface_ode/TL2003**: gas‑poor 既定で無効であること、レガシー用途であることを E.007 の注意書きに統合する。  
