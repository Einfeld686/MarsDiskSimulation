# 1D セルループ並列化計画

**作成日**: 2025-12-24  
**ステータス**: 実装中（検証待ち）  
**対象**: `marsdisk/run_one_d.py` のセルループ（粘性拡散 C5 / セル間輸送なし前提）

---

## 概要

1D シミュレーションの単一ケースを高速化するため、セルループを並列化する。  
スイープ並列ではなく **同一条件内のセル計算を並列**で走らせることを目的とする。  
本実装は **Windows の .cmd 実行限定**とし、他 OS は対象外とする。

---

## 目的

- 1ケースの実行時間短縮（特にセル数が多い場合）
- 既存の数値解・出力形式を維持し、再現性と質量保存を崩さない
- スイープ並列（ケース並列）とは独立に制御可能にする

---

## 非スコープ

- セル間輸送・粘性拡散（C5）の並列化
- 物理モデルの変更や新式の導入
- 既存のケース並列（run_temp_supply_sweep*.cmd）の再設計
- 0D への影響（1D のみ対象）
- macOS/Linux での有効化・サポート

---

## 前提・制約

- **セル間結合は無効**であること（現状方針の維持）
- I/O は **メインスレッドのみ**が扱う（ストリーミング書き込みの競合回避）
- Numba 内部並列とセル並列の **過剰並列（オーバーサブスク）**を避ける
- 既存の出力差分は **数値丸め誤差範囲**に留める
- **Windows の .cmd 実行時のみ有効化**（他 OS では常に無効）
- 設定は **.cmd からの環境変数**で制御する（YAML/CLI 追加は行わない）

---

## 実装方針（案）

### 1. セル計算の関数分割

`run_one_d` 内のセルループを以下の形に分割する。

- `step_cell(...)` のような関数を新設し、**1セル分の更新処理**をまとめる
- 入力: セル固有パラメータ、状態（PSD/供給/シンク）、時刻・dt
- 出力: 次状態、診断値、ステップ集計用のスカラー

> 目的: スレッド並列時に **共有状態を書き換えない**構造にする。

### 2. 並列バックエンド

標準ライブラリで完結するため、初期実装は `concurrent.futures.ThreadPoolExecutor` を採用。

- NumPy/Numba の多くは GIL 解放されるため **スレッドで十分効果が見込める**
- `ProcessPoolExecutor` はシリアライズ負荷が大きいため、必要なら後段で検討

### 3. リダクションと順序保証

- 並列結果は **セル index 順に並べ替え**て集計
- 加算順序のブレを抑え、再現性を高める

### 4. 設定スイッチ（.cmd / 環境変数）

初期実装は **.cmd からの環境変数のみ**で制御する。

例（案）:

```bat
set MARSDISK_CELL_PARALLEL=1
set MARSDISK_CELL_JOBS=4
set MARSDISK_CELL_MIN_CELLS=4
set MARSDISK_CELL_CHUNK_SIZE=0
```

運用面:
- 既定は **無効**（従来挙動維持）
- `jobs` は `NUMBA_NUM_THREADS` と協調して調整

### 5. Numba スレッドとの協調

セル並列時の過剰並列を回避するため、以下の方針を検討する。

- `parallel.cells.jobs > 1` かつ `NUMBA_NUM_THREADS` 未指定の場合:
  - `NUMBA_NUM_THREADS = max(1, cores // jobs)` に自動設定

### 6. ロギング・設定スナップショット

- `run_config.json` に並列設定と実効値を記録
- 既存の `auto_tune` 情報に追記可能なら統合

---

## 作業ステップ

- [x] **セルループの依存関係整理**
  - 共有状態（配列・ログ・診断）の洗い出し
- [x] **セル計算関数の分離**
  - 入力/出力の型を定義し、副作用を削減
- [x] **並列実行の導入**
  - ThreadPool を用いてセル関数を並列実行
- [x] **集計・I/O の一本化**
  - 結果を順序整列し、メインスレッドで集約・記録
- [x] **.cmd 経由の設定導線を整備**
  - run_one_d に環境変数の解釈を追加
  - `.cmd` 側で既定値を設定
- [ ] **再現性・性能検証**
  - 並列オン/オフで `summary.json` を比較

---

## 検証計画

- **再現性テスト**
  - 同一設定で並列 ON/OFF の `summary.json` を比較
  - 許容差: `M_loss` など主要量が 1e-6〜1e-4 程度以内
- **質量保存**
  - `checks/mass_budget.csv` が 0.5% 以内
- **性能**
  - 1ケースの wall-time を計測し改善率を記録

---

## リスクと対策

| リスク | 影響 | 対策 |
|--------|------|------|
| オーバーサブスク | 逆に遅くなる | `NUMBA_NUM_THREADS` 調整 |
| 浮動小数の集計順序 | 差分が出る | セル index でソートして集計 |
| I/O 競合 | 出力破損 | メインスレッドのみで書き込み |
| 小規模ケースでの逆効果 | 実行が遅くなる | `min_cells` で直列化 |

---

## 方針決定

- セル並列のバックエンドは `thread` を採用
- `NUMBA_NUM_THREADS` 未指定時は `max(1, cores // jobs)` に制限してセル並列とバランスを取る
- 再現性比較の基準ケースは `configs/base.yml` を使用し、以下の最小構成で実行する
  - `geometry.Nr=4`, `sizes.n_bins=20`, `numerics.t_end_years=0.05`, `io.streaming.enable=false`
  - `NUMBA_NUM_THREADS=1` を固定して並列 ON/OFF を比較する
- 並列化の自動無効化条件は次を採用する
  - `geometry.mode != "1D"` または `geometry.Nr < 2`
  - セル間結合が有効な場合（粘性拡散/半径輸送の有効化フラグが追加されたら即無効化）
- Windows + .cmd 実行時のみ有効化（他 OS では無効）

---

## Open Questions

- （現時点なし）

---

## 受入基準

- 並列 OFF が既存と完全一致（回帰なし）
- 並列 ON で `summary.json` が許容差内
- `run_config.json` に並列設定が記録される
- 粘性拡散 / セル間輸送が有効な場合は **自動で並列を無効化**する
- Windows 以外では **必ず無効**であること

---

## 関連ドキュメント

- `marsdisk/run_one_d.py` — 1D 実行本体
- `marsdisk/runtime/autotune.py` — スレッド設定の自動調整
