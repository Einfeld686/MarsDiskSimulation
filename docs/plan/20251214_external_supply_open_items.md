外部供給の未実装事項（外部情報待ち）整理
==========================================

> [!WARNING]
> 非推奨/legacy: 現行の外部供給デフォルトは `docs/plan/20251220_optical_depth_external_supply_impl_plan.md` の optical_depth + tau_stop 方式で、τフィードバック/温度追従/リザーバー等は非推奨。再導入は比較試験に限定する。

目的
----
- 外部情報が揃うまで実装を保留している供給まわりの論点をまとめ、現行のデフォルト設定とその根拠を記録する。

補足: 先行研究から得られる数値・時間スケール
------------------------------------------
- 衝突後外側円盤の衝突時間は最大でも ~0.5 年程度、カスケードを考えるとより短いと見積もられている。P制御の時定数を 0.1–1 年に置くと、この衝突時間オーダーと整合する。
- 巨大衝突円盤の総質量はケース依存だが、Borealis 級では ~5×10^20 kg が例示される。一方、Phobos/Deimos を残すには M_disk ≲ 3×10^-5 M_Mars という上限も議論される。
- 内側から巨大衛星が形成・移動するシナリオでも時間スケールは ~100–1000 年で、2 年窓では貯蔵庫が枯渇する想定は小さい（極端な供給を除く）。
- 衝突直後の温度は 1000–6000 K 程度まで上がり得るが、蒸発は <5 wt% 程度という見積もりが多い。温度→供給の直接マップは文献に明示されていない。

外部情報が必要で未実装の項目
----------------------------
- **τフィードバック供給**: τ≈1 を狙って供給量を増減させる制御則は未実装。実装には「τに応じて輸送が変わる物理過程」「応答時間・飽和上限（貯蔵庫）」の根拠が必要。
- **有限貯蔵庫（総供給量の上限）**: 内側円盤に蓄えられた質量・漏出時間スケールの外部推定が未決定のため、現状は無限リザーバーを仮定したまま。
- **温度（冷却曲線）追従の供給**: 温度に比例/減衰させる具体的なマッピング（凝縮・破砕・昇華との対応付け）が未定。テーブル入力は可能だが、値を作る根拠が不足。
- **混合効率 ε_mix の物理レンジ**: 文献や実験値に基づく推奨範囲・半径/温度依存は未整理。現在は固定スカラーのみ。

現行の設定と根拠
----------------
- 供給モードは const/powerlaw/table/piecewise を実装済みで、**すべて時間依存のみ**。τベースのフィードバックや総量制限は組み込まず、「任意の時間関数を事前指定する」前提を維持。
- mixing は `epsilon_mix`（`mu` エイリアス）で一括スケールし、デフォルト 0.05。実装側では `get_prod_area_rate` が最後に乗算し、負値を `max(…,0)` で除去する（安全側の既定）。
- powerlaw は `A*((t-t0)+1e-12)^index` をそのまま評価し、指数<0 のときはユーザーが `t0` を正に取る運用を想定（発散ガードは未実装）。
- table/piecewise により「初期一定→後半減衰」や任意の冷却曲線を**手動でテーブル化**すれば再現可能。ただし温度との自動連結は行わず、科学的根拠を利用者が与える方針。
- 貯蔵庫や τ フィードバックを省いている理由は、「gas-poor 0D 表層 ODEの最小モデルを保つ」「恣意的な制御則に依存しない」ため。必要性が確定した時点で上記の外部情報を取り込んで追加実装する。

実装着手前に確認したい点（合意待ち）
------------------------------------
- `fixed_tau1_sigma=auto_max` を正式サポートする場合、スキーマ許容と margin（現状案は+5%）を固定でよいか、YAMLで可変にするか。
- 供給リザーバー上限の持たせ方: 例として `supply.reservoir.mass_total_Mmars` を減算し、ゼロ到達で供給を停止または減衰させる挙動でよいか。summary に残量を記録するか。
- τフィードバックを「制御実験」モードで入れる場合の仕様: 目標 τ, 比例ゲインのみの単純制御で足りるか、応答時間・上限クリップ・飽和を別パラメータで持たせる必要があるか。
- 温度→供給テーブル自動生成ユーティリティを追加する場合の入力系列: `radiation.mars_temperature_driver.table` に依存して CSV を吐く形でよいか、別の温度ソースを参照するか。

先行研究に基づく線引きメモ（実装の位置づけ）
------------------------------------------
- **τフィードバック供給**: 先行研究に直接的な輸送則なし。物理モデルではなく「τ≈1を維持するために必要供給を逆算する実験モード」に限定するのが安全。P制御（目標τとの差に比例）で十分だが、上限クリップと反応時定数（推奨オーダー0.1–1年、衝突時間見積もりと同オーダー）を持たせると暴走しにくい。
- **有限貯蔵庫**: 巨大衝突円盤は有限質量（例: Borealis級で ~5×10^20 kg）、小衛星シナリオでは M_disk ≲ 3×10^-5 M_Mars の上限もある。供給の無限化防止のため、本番でも「上限クリップ＋残量記録」を入れる価値が高い。2年窓では総量が支配的になりにくいが、減算停止/減衰のログ化を推奨。
- **温度追従供給**: 温度→供給の直接マップは文献からは与えられない（高温・揮発の存在のみ）。自動連結は本番既定にしない。テーブルを使うなら「どの温度系列を使ったか」を設定/ヘッダで明示し、仮定扱いとする。
- **ε_mix 範囲**: 衝突時間が年未満になり得るため上限側（効率高め）の余地はあるが、外側円盤の緩和不確かさもある。0–1 を物理上限とし、本番は 0.01, 0.05, 0.1, 0.5, 1.0 など対数的スイープを推奨（デフォルト 0.05 のまま）。

質問への一次回答（実装パラメータの指針）
- `fixed_tau1_sigma=auto_max` margin: デバッグ専用で明記。5%をデフォルトとしつつ、YAML可変にするのが無難（物理根拠のない定数を固定しないため）。
- 供給リザーバー: `supply.reservoir.mass_total_Mmars` などで総量を減算管理し、0到達で停止または緩やか減衰。summary に残量を記録する方針で合意したい。
- τフィードバック制御: 本番には使わず「制御実験モード」に限定。P制御に加えて上限クリップと時定数パラメータを持たせる案で検討。
- 温度→供給テーブル生成: 設定で温度系列を選べる形が望ましい。生成CSVに温度ソースをメタデータとして残す。
