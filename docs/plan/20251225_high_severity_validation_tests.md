# 高優先度数式リスクの検証テスト計画 (2025-12-25)

## 目的と背景
- 数式の実装ミスが疑われる箇所（重大度:高）について、検証用テストを追加し「本当に問題ないか」を客観的に確認する。
- 仕様の根拠は `analysis/equations.md` と既存実装の挙動に合わせ、不要な新式導入は行わない。

## 対象範囲
- 0D 物理実装のうち、重大度:高で挙げた4項目の検証テスト追加。
- テストは単体/小規模統合の範囲で実装し、CI で再現可能な規模に留める。

## 非対象範囲
- analysis/ 文書や式番号の更新（検証結果を踏まえた修正時に別途実施）。

## 検証結果と仕様照合（暫定）
1. PSD サイズドリフト再ビン
   - 仕様根拠: `analysis/equations.md` の `N_bin` は「ビンごとの相対数密度」。
   - 判定: 現行テストは `dN/ds` 前提で再ビンしており仕様と不整合。**仕様違反ではなくテスト修正対象**。
2. 供給 `powerlaw_bins` 注入
   - 仕様根拠: (E.046) の「`mode="powerlaw_bins"` で `dN/ds∝s^{-q}` を分配」。
   - 判定: 実装が `m_k` で割るため `dN/ds` が `s^{-(q+3)}` になっている。**仕様違反として修正対象**。
3. 破片テンソルの質量保存
   - 仕様根拠: (E.046) の `Y_{kij}` は質量分布の正規化で `∑_k Y_{kij}=1`。
   - 判定: Numba fallback と Python 実装が二重に加算され、`∑_k Y_{kij}=2` になる。**仕様違反として修正対象**。
4. Smol ブローアウト時間と `chi_blow`
   - 仕様根拠: `t_blow = chi_blow/Ω`（`analysis/overview.md`）。
   - 判定: Smol 側のブローアウトで `chi_blow` を未反映。**仕様違反として修正対象**。

## 方針
- 重大度が高い順にテストを設計・実装する。
- 仕様が曖昧な箇所は UNKNOWN_REF_REQUESTS に登録し、テストを `xfail` で保留するか、仕様確定後に実装する。

## テスト設計（高→低）
1. PSD サイズドリフト再ビンの整合性
   - 対象コード: `marsdisk/physics/psd.py`
   - テスト案: 既知の `dN/ds` 分布を作り、`ds/dt` が小さいケースで「粒子数の保存」と「質量比の期待値」を検証。
   - 期待: クリップ無しの領域では `sum(n*width)` と `sum(n*s^3*width)` が数値誤差範囲で保存される。
2. 供給 `powerlaw_bins` 注入の指数整合
   - 対象コード: `marsdisk/physics/collisions_smol.py`
   - テスト案: 連続的なサイズ配列で注入後の `dN/ds` を回帰し、指数 `q` に一致するかを確認。
   - 期待: 近似直線の傾きが `-q` になり、質量総和が `prod_rate` と一致する。
3. 破片テンソルの最大残渣と質量保存
   - 対象コード: `marsdisk/physics/collisions_smol.py`
   - テスト案: 低速衝突で `f_lr≈1` のケースを作り、`sum_k Y[k,i,j]=1` と `Y[k_lr,i,j]≈f_lr` を検証。
   - 期待: 最大残渣が二重に加算されず、総和が1に保たれる。
4. Smol ブローアウト時間と `chi_blow` の整合
   - 対象コード: `marsdisk/run_zero_d.py`, `marsdisk/physics/collisions_smol.py`
   - テスト案: `chi_blow` を変えたケースで Smol 側のブローアウト率が表層ODEと同じスケーリングになるかを確認。
   - 期待: `chi_blow` の倍率に応じて `t_blow` が伸縮し、損失率が一致する。

## 推奨と理由
- 合格条件/許容誤差は段階分け（単体: 相対誤差1e-6、回帰: |Δq|≤0.1 かつ R^2≥0.98、統合: ≤5e-3）を採用。
  - 理由: 数値誤差を吸収しつつCIで安定に判定できるため。
- PSDの量の定義は `psd_state["number"]` が **ビンごとの相対数密度**（`N_bin`）である点に合わせる。
  - 理由: `analysis/equations.md` の表記と既存の PSD 再ビン実装の前提を一致させるため。
- 供給注入の指数 q は `dN/ds ∝ s^{-q}` を正とし、その傾きを検証する。
  - 理由: カスケードの標準定義に沿い、テスト期待値が一意になるため。
- 破片テンソルは `∑_k Y_{kij}=1` を満たし、`Y_{k_lr,ij} ≥ f_lr` かつ `≤1` を確認する。
  - 理由: 最大残渣を含む分配の正規化を優先し、二重加算の検出に集中するため。
- `chi_blow` は表層ODE/Smol双方に同じ `t_blow=chi_blow/Ω` を適用（もしくは設定で明示的に分岐）。
  - 理由: 経路での不整合を避け、損失率の比較テストを安定化するため。

## 実装タスク（チェックリスト）
- [x] テスト仕様の根拠を整理（式/既存挙動の確認メモを残す）
- [x] テスト実装: PSD ドリフト整合（`tests/unit/test_psd_size_drift_consistency.py`）
- [x] テスト実装: 供給 `powerlaw_bins` 注入指数（`tests/unit/test_supply_injection_powerlaw_slope.py`）
- [x] テスト実装: 破片テンソル LR/質量保存（`tests/unit/test_fragment_tensor_lr_mass.py`）
- [x] テスト実装: `chi_blow` 整合（`tests/integration/test_blowout_chi_scaling.py`）
- [x] pytest 実行（`IO_STREAMING=off` を指定）
- [x] 仕様違反の修正（供給指数/破片テンソル/`chi_blow`）
- [x] テスト再実行と評価

## リスクと緩和策
- 仕様が曖昧な場合にテストが仕様不一致で不安定化する。
  - 対策: UNKNOWN_REF_REQUESTS 登録 + `xfail` で保留し、仕様確定後に切り替える。
- 数値誤差で判定が揺らぐ。
  - 対策: 誤差許容範囲を明示し、比較対象の正規化を徹底する。

## 実行後の確認
- 追加テストが CI で安定に通ること。
- 失敗した場合は原因切り分けと修正方針を別プランに記録する。
