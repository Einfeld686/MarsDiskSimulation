# τ≃1 未達（固体/液体判定絡み）の現状メモ

## 状況
- 固体/液体判定を含む設定で、開始時に視線方向 τ≈1 を狙った初期化をしても τ が十分に立たず、固体状態でも τ≃1 に到達しないケースが残っている。
- run.py を元の版へ戻すと出力は正常に生成されることを確認済み（series/・checkpoints/・summary が欠損する問題は run.py 変更が原因だった）。
- `scripts/research/run_temp_supply_sweep.sh` で実行した際、T3000_mu0p1_phi60 などのケースで τ~1 が期待値から外れる挙動が再現する。

## これまでの試行
- init_tau1 を LOS τ=1 に合わせる修正を一度入れたが、初期化途中で落ちて出力が生成されなくなる副作用があり、現在は run.py を元に戻している。
- ステージログや短縮ラン（T_END_SHORT_YEARS=0.001、MARSDISK_DEBUG_STAGE=1）での切り分けは試行したが、run.py 変更版では途中で落ち、元の版では正常完走。
- ストリーミング＋マージ、チェックポイントを有効にしても症状は変わらず（出力欠損は run.py 変更由来と判断）。

## 依頼事項
- τ~1 を固体/液体判定込みで確実に達成するための原因分析と修正案を検討すること。
- 今回は run.py の再変更による出力欠損を避けるため、別ブランチ・別ファイルでの再現ログ取得と段階的修正を行う方針が望ましい。

## 追加メモ（2025-12-15）
- フェーズ（固体/液体）に関わらず初期化時点で `sigma_tau1_limit` を決定し、以後のステップで None にならないよう run.py 初期化ロジックを修正しようとしたが、バグで失敗。具体的には:
  - `init_tau1` に `target_tau` / `tau_field` を導入し、LOS τ=1 でキャップを計算するロジックを追加。
  - その際のコード変更で例外処理のインデント崩れや `_log_stage` 呼び出しの引数ミスマッチを混入させ、run.py が起動直後に落ち、出力が一切生成されない状態になった。
  - テスト `tests/integration/test_init_tau1_los_target.py` で初期 τ=1 を保証する確認を追加したが、run.py 側のバグで本番実行では series/checkpoints が生成されず失敗。
- 結論: `sigma_tau1_limit` を初期化で確定させる改修は、run.py を別ブランチで安全に実装し直し、短縮ラン＋ステージログ付きで検証してから統合する必要がある。
