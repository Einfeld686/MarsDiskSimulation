# Q_D* 1–7 km/s 固定テーブル運用と μ変更の取り扱い（修正プラン）

## 目的
`marsdisk/physics/qstar.py` の **1–7 km/s テーブルを固定値としてデフォルト運用**しつつ、μ変更ユースケースに対して誤解や不整合（キャッシュ・警告）を起こさない挙動へ整理する。

## 背景 / 課題
- `qstar (1).py` で 1–7 km/s テーブルを追加したが、**μを変更してもテーブル値が更新されない**ため期待とのズレが起こり得る。
- キャッシュキーに μ が含まれておらず、**μ変更後も古い結果が返る可能性**がある。
- 実運用のインポート先は `qstar.py` のため、**反映先を明確化**する必要がある。

## 方針（今回の前提）
- **1–7 km/s テーブルは固定値として扱う**（将来的にもデフォルト固定）。
- μ変更は **v<1 / v>7 km/s の外挿にのみ影響**する。
- μ変更時は **キャッシュを無効化**して整合性を保つ。

## 受け入れ条件（Done）
- 1–7 km/s の範囲内では μ変更によって `Q_D^*` が変化しないことが明確に仕様化・実装されている。
- v<1 / v>7 km/s では μ変更が `Q_D^*` に反映される。
- μ変更後にキャッシュ由来の古い値が返らない。
- 速度クランプ警告は v<1 / v>7 km/s のみに発生する。
- 関連テストが追加され、既存テストが通る。

## 実装手順（チェックリスト）

### 適用先の確定
- [x] `marsdisk/physics/qstar.py` を更新するか、`qstar (1).py` を正式版としてリネームするか決める。
- [x] 反映先が決まったら、重複ファイルの扱い（保持/削除）を決定する。

### コード修正
- [x] `_DEFAULT_COEFFS` のコメントを「固定テーブル前提」に更新する。
- [x] `set_gravity_velocity_mu()` で `_QDSTAR_CACHE` を必ずクリアする（またはキャッシュキーに μ を追加する方針を選ぶ）。
- [x] `compute_q_d_star_F1` / `compute_q_d_star_array` の docstring に「μは範囲外のみ反映」と明記する。
- [x] 速度クランプ警告が **[1, 7] km/s** を境界として出ることを確認・調整する。

### テスト追加
- [ ] `tests/integration/test_qstar_units.py` に、μ変更が **v<1 / v>7** のみに影響するテストを追加する。
- [ ] μ変更後にキャッシュが再計算されることを確認するテストを追加する。
- [ ] v=1 / v=7 での境界連続性（不連続な飛びが無い）を簡易確認する。

### 検証
- [x] `pytest tests/integration/test_qstar_units.py` を実行して更新テストを確認する。
- [x] qstar 関連の回帰テスト（必要最小限）を通す。

## スコープ外（将来検討）
- 1–7 km/s テーブルを μ で再生成する **派生テーブルモード**の導入。
- 外部 CSV/NPZ テーブルの読み込み（デフォルト固定値運用の後に検討）。
