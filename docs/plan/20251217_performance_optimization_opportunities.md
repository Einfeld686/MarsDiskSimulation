# æ•°å€¤è¨ˆç®—é«˜é€ŸåŒ–å¯èƒ½æ€§ãƒ¬ãƒãƒ¼ãƒˆ

**ä½œæˆæ—¥**: 2025-12-17  
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: èª¿æŸ»å®Œäº†ãƒ»ææ¡ˆ  
**å¯¾è±¡**: `marsdisk/` æ•°å€¤è¨ˆç®—ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«å…¨èˆ¬  
**é–¢é€£**: [20251212_simulation_performance_optimization.md](docs/plan/20251212_simulation_performance_optimization.md)

---

## æ¦‚è¦

`marsdisk/` ã®æ•°å€¤è¨ˆç®—ã‚³ãƒ¼ãƒ‰ã‚’ç¶²ç¾…çš„ã«èª¿æŸ»ã—ã€é«˜é€ŸåŒ–ã®ä½™åœ°ã‚’åˆ†æã—ãŸã€‚æœ¬æ–‡æ›¸ã¯æ–½ç­–ã®å„ªå…ˆåº¦ã¨æŠ€è¡“çš„è©³ç´°ã‚’ã¾ã¨ã‚ã‚‹ã€‚

---

## ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«çµæœï¼ˆå®Ÿæ¸¬ï¼‰

**æ¸¬å®šæ¡ä»¶**: `configs/base.yml`, `t_end_years=0.01`, `n_bins=40`  
**ç·å®Ÿè¡Œæ™‚é–“**: 98.4ç§’ (ç´„158,000ã‚¹ãƒ†ãƒƒãƒ—)

### tottimeï¼ˆè‡ªå·±æ™‚é–“ï¼‰ä¸Šä½

| é †ä½ | é–¢æ•° | tottime (s) | å‰²åˆ | å‚™è€ƒ |
|------|------|-------------|------|------|
| 1 | `run_zero_d.py:run_zero_d` | 16.2 | 16.5% | ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ—ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰ |
| 2 | `numpy.ufunc.reduce` | 4.1 | 4.2% | é…åˆ—æ¼”ç®—ã®é›†ç´„ |
| 3 | `tables.py:interp` | 3.5 | 3.6% | Q_pr ãƒ†ãƒ¼ãƒ–ãƒ«è£œé–“ |
| 4 | **`c_einsum`** | **3.4** | **3.5%** | `np.einsum` æœ¬ä½“ |
| 5 | `radiation.py:qpr_lookup` | 3.4 | 3.5% | Planck Q_pr ãƒ«ãƒƒã‚¯ã‚¢ãƒƒãƒ— |
| 6 | `fromnumeric.py:_wrapreduction` | 3.3 | 3.4% | NumPy reduce ãƒ©ãƒƒãƒ‘ãƒ¼ |
| 7 | `collisions_smol.py:step_collisions_smol_0d` | 2.4 | 2.4% | è¡çªã‚¹ãƒ†ãƒƒãƒ—æœ¬ä½“ |
| 8 | `collide.py:compute_collision_kernel_C1` | 2.0 | 2.0% | è¡çªã‚«ãƒ¼ãƒãƒ«æ§‹ç¯‰ |
| 9 | `smol.py:step_imex_bdf1_C3` | 1.6 | 1.6% | IMEX ã‚½ãƒ«ãƒãƒ¼ |
| 10 | `psd.py:compute_kappa` | 1.2 | 1.2% | Îº è¨ˆç®— |

### cumtimeï¼ˆç´¯ç©æ™‚é–“ï¼‰ä¸Šä½

| é †ä½ | é–¢æ•° | cumtime (s) | å‰²åˆ | å‚™è€ƒ |
|------|------|-------------|------|------|
| 1 | `run_zero_d` | 97.0 | 98.6% | ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å…¨ä½“ |
| 2 | `step_collisions` | 24.4 | 24.8% | **æœ€å¤§ãƒ›ãƒƒãƒˆã‚¹ãƒãƒƒãƒˆ** |
| 3 | `_resolve_blowout` | 23.4 | 23.8% | Q_pr å‘¼ã³å‡ºã—å«ã‚€ |
| 4 | `qpr_lookup` | 21.3 | 21.7% | ãƒ†ãƒ¼ãƒ–ãƒ«è£œé–“å«ã‚€ |
| 5 | `tables.py:interp` | 9.4 | 9.6% | 2D è£œé–“ |
| 6 | `step_imex_bdf1_C3` | 7.7 | 7.8% | IMEX ã‚½ãƒ«ãƒãƒ¼ |
| 7 | `logging.info` | 6.4 | 6.5% | ãƒ­ã‚®ãƒ³ã‚° |
| 8 | `compute_collision_kernel_C1` | 4.3 | 4.4% | è¡çªã‚«ãƒ¼ãƒãƒ« |
| 9 | `np.einsum` | 3.4 | 3.5% | gain è¨ˆç®— |

### åˆ†æ

1. **æœ€å¤§ãƒœãƒˆãƒ«ãƒãƒƒã‚¯ã¯ `qpr_lookup` (21.3s, 21.7%)**
   - Q_pr ãƒ†ãƒ¼ãƒ–ãƒ«ã®2Dè£œé–“ãŒæ¯ã‚¹ãƒ†ãƒƒãƒ—1,262,314å›å‘¼ã°ã‚Œã‚‹
   - è£œé–“è‡ªä½“ (`tables.py:interp`) ã« 9.4s
   - **æ¨å¥¨**: Q_pr å€¤ã‚’ã‚¹ãƒ†ãƒƒãƒ—ã”ã¨ã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆæ¸©åº¦ãƒ»ã‚µã‚¤ã‚ºãŒå¤‰ã‚ã‚‰ãªã‘ã‚Œã°å†è¨ˆç®—ä¸è¦ï¼‰

2. **`step_collisions_smol_0d` (24.4sç´¯ç©) ãŒç¬¬2ãƒ›ãƒƒãƒˆã‚¹ãƒãƒƒãƒˆ**
   - è¡çªã‚«ãƒ¼ãƒãƒ«æ§‹ç¯‰ + IMEX ã‚½ãƒ«ãƒãƒ¼ + einsum ã‚’å«ã‚€

3. **`np.einsum` ã¯ 3.4s (3.5%) ã§å½“åˆæ¨å®šã‚ˆã‚Šå½±éŸ¿å°**
   - å…¨ä½“ã® 3.5% ã§ã‚ã‚Šã€JIT åŒ–ã®åŠ¹æœã¯é™å®šçš„
   - 2ã€œ5å€ã®æ¨å®šã¯éå¤§è©•ä¾¡

4. **ãƒ­ã‚®ãƒ³ã‚°ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰ 6.4s (6.5%)**
   - `logger.info` ãŒ 315,582 å›å‘¼ã°ã‚Œã‚‹
   - **æ¨å¥¨**: INFO â†’ DEBUG ã«å¤‰æ›´ã€ã¾ãŸã¯ã‚¬ãƒ¼ãƒ‰è¿½åŠ 

---


### Numba JIT é©ç”¨çŠ¶æ³

| ãƒ•ã‚¡ã‚¤ãƒ« | é–¢æ•°å | èª¬æ˜ | ä¸¦åˆ—åŒ– |
|----------|--------|------|--------|
| `_numba_kernels.py` | `compute_weights_table_numba` | power-law fragment weight ã®äº‹å‰è¨ˆç®— | âŒ |
| `_numba_kernels.py` | `fill_fragment_tensor_numba` | fragment tensor `Y[k,i,j]` ã®æ§‹ç¯‰ | âœ… (`prange`) |

### ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ©Ÿæ§‹

- **Fragment tensor cache**: `_FRAG_CACHE` (æœ€å¤§8ã‚¨ãƒ³ãƒˆãƒªã€ã‚¹ã‚«ãƒ©ãƒ¼ `v_rel` ã®å ´åˆã®ã¿)

---

## é«˜é€ŸåŒ–å¯èƒ½æ€§ä¸€è¦§

### ğŸ”´ é«˜å„ªå…ˆåº¦ï¼ˆåŠ¹æœå¤§ï¼‰

#### 1. `np.einsum` ã® Numba åŒ–

**å ´æ‰€**: [smol.py:255](marsdisk/physics/smol.py#L255)

```python
gain = 0.5 * np.einsum("ij,kij->k", C, Y)
```

| é …ç›® | å†…å®¹ |
|------|------|
| **å•é¡Œ** | O(nÂ³) æ¼”ç®—ã‚’ç´”ç²‹ NumPy ã§æ¯ã‚¹ãƒ†ãƒƒãƒ—å®Ÿè¡Œ |
| **æ¨å®šåŠ¹æœ** | 2ã€œ5å€ï¼ˆæœªæ¸¬å®šã€é¡ä¼¼å‡¦ç†ã® JIT åŒ–å®Ÿç¸¾ã«åŸºã¥ãæ¨å®šï¼‰ |
| **å®Ÿè£…é›£æ˜“åº¦** | ä¸­ |
| **ææ¡ˆ** | Numba JIT ã‚«ãƒ¼ãƒãƒ«ã«ç½®æ›ã—ã€`prange` ã§ä¸¦åˆ—åŒ– |

---

#### 2. è¡çªã‚«ãƒ¼ãƒãƒ«è¨ˆç®—ã®æœ€é©åŒ–

**å ´æ‰€**: [collide.py:compute_collision_kernel_C1](marsdisk/physics/collide.py#L18-78)

```python
kernel = N_outer / (1.0 + delta) * np.pi * (s_sum ** 2) * v_mat / (np.sqrt(2.0 * np.pi) * H_ij)
```

| é …ç›® | å†…å®¹ |
|------|------|
| **å•é¡Œ** | `np.outer`, `np.add.outer` ãŒæ¯ã‚¹ãƒ†ãƒƒãƒ—å‘¼ã°ã‚Œã‚‹ |
| **æ¨å®šåŠ¹æœ** | 1.5ã€œ2å€ï¼ˆæœªæ¸¬å®šã€è¦ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒªãƒ³ã‚°ï¼‰ |
| **ææ¡ˆ** | Numba JIT åŒ– |

> [!WARNING]
> `N` ã¨ `H` ã¯ã‚¹ãƒ†ãƒƒãƒ—ã”ã¨ã«æ›´æ–°ã•ã‚Œã‚‹ãŸã‚ï¼ˆ[collisions_smol.py:640-735](marsdisk/physics/collisions_smol.py#L640-735)ï¼‰ã€ã‚«ãƒ¼ãƒãƒ«å…¨ä½“ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã¯å®Ÿè³ªå†åˆ©ç”¨ä¸å¯ã€‚ã‚­ãƒ£ãƒƒã‚·ãƒ¥å¯¾è±¡ã¯ã‚µã‚¤ã‚ºé…åˆ— `s` ã‚„å›ºå®š `v_rel` ã«é™å®šã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚

---

#### 3. Q_D* è¨ˆç®—ã®ãƒ†ãƒ¼ãƒ–ãƒ«åŒ–

**å ´æ‰€**: [qstar.py:compute_q_d_star_array](marsdisk/physics/qstar.py#L165-194)

| é …ç›® | å†…å®¹ |
|------|------|
| **å•é¡Œ** | é€Ÿåº¦è£œé–“ã‚’å«ã‚€è¤‡é›‘ãªé…åˆ—æ¼”ç®— |
| **æ¨å®šåŠ¹æœ** | 1.5ã€œ3å€ |
| **ææ¡ˆ** | Numba JIT åŒ– or ãƒ«ãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ†ãƒ¼ãƒ–ãƒ«äº‹å‰è¨ˆç®— |

---

#### 4. æ˜‡è¯è¨ˆç®—ã®æœ€é©åŒ–

**å ´æ‰€**: [sublimation.py](marsdisk/physics/sublimation.py)

ç‰¹ã« `p_sat` é–¢æ•°ç¾¤ï¼ˆClausius-Clapeyron è©•ä¾¡ï¼‰ãŒãƒ›ãƒƒãƒˆã‚¹ãƒãƒƒãƒˆã€‚

| é …ç›® | å†…å®¹ |
|------|------|
| **å•é¡Œ** | `p_sat_clausius`, `choose_psat_backend` ãŒæ¯ã‚¹ãƒ†ãƒƒãƒ—è©•ä¾¡ |
| **æ¨å®šåŠ¹æœ** | 1.5ã€œ2å€ |
| **ææ¡ˆ** | ãƒ†ãƒ¼ãƒ–ãƒ«è£œé–“ã®äº‹å‰æ§‹ç¯‰ã¨ Numba åŒ– |

---

### ğŸŸ¡ ä¸­å„ªå…ˆåº¦ï¼ˆåŠ¹æœä¸­ï¼‰

#### 5. IMEX-BDF(1) ã‚½ãƒ«ãƒãƒ¼ã®åå¾©å‰Šæ¸›

**å ´æ‰€**: [smol.py:step_imex_bdf1_C3](marsdisk/physics/smol.py#L146-276)

```python
while True:
    N_new = (N_arr + dt_eff * (gain + source_arr - S_arr * N_arr)) / (1.0 + dt_eff * loss)
    if np.any(N_new < 0.0):
        dt_eff *= 0.5
        continue
    ...
```

| é …ç›® | å†…å®¹ |
|------|------|
| **å•é¡Œ** | åˆæœŸ `dt` ãŒéå¤§ã ã¨è² å€¤ã‚„è³ªé‡èª¤å·®ã§å¼¾ã‹ã‚Œã€åå¾©å›æ•°ãŒå¢—åŠ ï¼ˆ[smol.py:244-275](marsdisk/physics/smol.py#L244-275)ï¼‰ |
| **ææ¡ˆ** | åˆæœŸ `dt` æ¨å®šã‚’ `t_coll` ãƒ™ãƒ¼ã‚¹ã§ã‚ˆã‚Šæ­£ç¢ºã«è¨­å®š |

---

#### 6. `_blowout_sink_vector` ã®æœ€é©åŒ–

**å ´æ‰€**: [collisions_smol.py:366-379](marsdisk/physics/collisions_smol.py#L366-379)

```python
mask = sizes <= a_blow
sink = np.zeros_like(sizes, dtype=float)
sink[mask] = Omega
```

| é …ç›® | å†…å®¹ |
|------|------|
| **ç¾çŠ¶** | ãƒ–ãƒ¼ãƒ«ãƒã‚¹ã‚¯ + ã‚¼ãƒ­é…åˆ— |
| **ææ¡ˆ** | in-place æ¼”ç®—ã¾ãŸã¯ `np.where` ã«å¤‰æ›´ |

---

#### 7. PSD çŠ¶æ…‹å¤‰æ›ã®é«˜é€ŸåŒ–

**å ´æ‰€**: [smol.py:psd_state_to_number_density / number_density_to_psd_state](marsdisk/physics/smol.py#L25-143)

| é …ç›® | å†…å®¹ |
|------|------|
| **å•é¡Œ** | è¾æ›¸ã‚¢ã‚¯ã‚»ã‚¹ `psd_state.get()` ãŒæ¯å›å‘¼ã°ã‚Œã‚‹ |
| **ææ¡ˆ** | dataclass ã¸ã®å¤‰æ›´ã§å±æ€§ã‚¢ã‚¯ã‚»ã‚¹é«˜é€ŸåŒ– |

---

### ğŸŸ¢ ä½å„ªå…ˆåº¦ï¼ˆåŠ¹æœå°ã€œå¾®ï¼‰

#### 8. ãƒ­ã‚®ãƒ³ã‚°ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰ã®å‰Šæ¸›

**å ´æ‰€**: `dynamics.py` ã® `v_ij`, `v_rel_pericenter` ç­‰

```python
logger.info("v_ij: e=%f i=%f v_k=%f -> v_rel=%f", e, i, v_k, v_rel)
```

| é …ç›® | å†…å®¹ |
|------|------|
| **å•é¡Œ** | `logger.info` ãŒæ¯å›å‘¼ã°ã‚Œã‚‹ï¼ˆå¼•æ•°è©•ä¾¡ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰ï¼‰ |
| **ææ¡ˆ** | `if logger.isEnabledFor(logging.DEBUG):` ã‚¬ãƒ¼ãƒ‰ã‚’è¿½åŠ  |

---

#### 9. å…¥åŠ›æ¤œè¨¼ã®é‡è¤‡å‰Šæ¸›

å¤šãã®é–¢æ•°ã§ `np.asarray` ã¨å½¢çŠ¶ãƒã‚§ãƒƒã‚¯ãŒé‡è¤‡ã€‚

| é …ç›® | å†…å®¹ |
|------|------|
| **ææ¡ˆ** | ä¸Šæµã§ä¸€åº¦æ¤œè¨¼ã—ã€å†…éƒ¨é–¢æ•°ã§ã¯çœç•¥å¯èƒ½ãƒ•ãƒ©ã‚°ã‚’è¿½åŠ  |

---

#### 10. å˜ç²¾åº¦ (float32) å¯¾å¿œ

ç¾çŠ¶ã¯ã™ã¹ã¦ `float64`ã€‚

| é …ç›® | å†…å®¹ |
|------|------|
| **æ³¨æ„** | æ•°å€¤ç²¾åº¦ã®åŠ£åŒ–ãƒªã‚¹ã‚¯ã‚ã‚Šã€æ…é‡ãªæ¤œè¨¼ãŒå¿…è¦ |
| **ææ¡ˆ** | ç²¾åº¦è¦ä»¶ãŒç·©ã„ãƒ•ã‚§ãƒ¼ã‚ºã§ã®ã¿æ¤œè¨ |

---

## ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ãƒ¬ãƒ™ãƒ«ã®æœ€é©åŒ–å€™è£œ

| æ–½ç­– | èª¬æ˜ | åŠ¹æœ | ãƒªã‚¹ã‚¯ |
|------|------|------|--------|
| **ã‚¢ãƒ€ãƒ—ãƒ†ã‚£ãƒ–ãƒ“ãƒ³æ•°** | åˆæœŸã¯ç²—ã„ã‚°ãƒªãƒƒãƒ‰ã€å¿…è¦é ˜åŸŸã®ã¿ç´°åˆ†åŒ– | ä¸­ã€œå¤§ | å®Ÿè£…è¤‡é›‘ |
| **ã‚¹ãƒ‘ãƒ¼ã‚¹ã‚«ãƒ¼ãƒãƒ«** | `C[i,j] â‰ˆ 0` ãŒå¤šã„å ´åˆã«ã‚¹ãƒ‘ãƒ¼ã‚¹è¡Œåˆ—ä½¿ç”¨ | ä¸­ | æ¡ä»¶æ¬¡ç¬¬ |
| **æ™‚é–“ã‚¹ãƒ†ãƒƒãƒ—æœ€é©åŒ–** | å®‰å…¨ä¿‚æ•°ã®å‹•çš„èª¿æ•´ | å°ã€œä¸­ | è³ªé‡èª¤å·®ãƒªã‚¹ã‚¯ |

---

## ä¸¦åˆ—åŒ–ã‚ªãƒ—ã‚·ãƒ§ãƒ³

| æ‰‹æ³• | ç¾çŠ¶ | ãƒãƒ†ãƒ³ã‚·ãƒ£ãƒ« |
|------|------|--------------|
| **Numba prange** | fragment tensor ã®ã¿ | è¡çªã‚«ãƒ¼ãƒãƒ«ã€einsum ç­‰ã«æ‹¡å¼µå¯èƒ½ |
| **ãƒãƒ«ãƒãƒ—ãƒ­ã‚»ã‚¹** | ã‚¹ã‚¤ãƒ¼ãƒ—ã§å®Ÿè£…æ¸ˆã¿ (`--jobs N`) | åŠ¹æœçš„ã«æ´»ç”¨ä¸­ |
| **GPU (CuPy/JAX)** | æœªå®Ÿè£… | n_bins >> 100 ã§æœ‰åŠ¹ã ãŒç¾çŠ¶ 40 ã§ã¯æ©æµå° |

---

## æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³

1. **ã¾ãšæ¸¬å®š**: `cProfile` ã¾ãŸã¯ `py-spy` ã§å®Ÿéš›ã®ãƒœãƒˆãƒ«ãƒãƒƒã‚¯ã‚’ç‰¹å®š
2. **einsum æœ€é©åŒ–**: æœ€ã‚‚åŠ¹æœãŒè¦‹è¾¼ã‚ã‚‹
3. **è¡çªã‚«ãƒ¼ãƒãƒ«ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥/JIT åŒ–**
4. **Q_D* ãƒ†ãƒ¼ãƒ–ãƒ«äº‹å‰è¨ˆç®—**

---

## ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒªãƒ³ã‚°ã‚³ãƒãƒ³ãƒ‰

```bash
# cProfile ã§æ¸¬å®š
python -m cProfile -s tottime -m marsdisk.run --config configs/base.yml 2>&1 | head -50

# py-spy ã§ãƒ•ãƒ¬ãƒ¼ãƒ ã‚°ãƒ©ãƒ•
py-spy record -o flame.svg -- python -m marsdisk.run --config configs/base.yml
```

---

## é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- [20251212_simulation_performance_optimization.md](docs/plan/20251212_simulation_performance_optimization.md) â€” å®Ÿè¡Œæ™‚é–“çŸ­ç¸®è¨ˆç”»ï¼ˆæ–½ç­–è©³ç´°ï¼‰
- [marsdisk/physics/_numba_kernels.py](marsdisk/physics/_numba_kernels.py) â€” æ—¢å­˜ Numba ã‚«ãƒ¼ãƒãƒ«
- [marsdisk/physics/smol.py](marsdisk/physics/smol.py) â€” IMEX ã‚½ãƒ«ãƒãƒ¼
- [marsdisk/physics/collide.py](marsdisk/physics/collide.py) â€” è¡çªã‚«ãƒ¼ãƒãƒ«
